name: Test build_pyoptsparse.snopt_module

on:
  # Trigger on push or pull request events for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # # Run the workflow Sundays at 0400 UTC
  # schedule:
  #   - cron: '0 4 * * 0'

  # Allow running the workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      run_name:
        description: 'Name of workflow run as it will appear under Actions tab (optional):'
        type: string
        required: false
        default: ''
      debug_enabled:
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        type: boolean
        required: false
        default: false

run-name:  ${{ inputs.run_name }}

jobs:

  test-build-snopt-module:

    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, macos-latest]
        python-version: ['3.11', '3.12', '3.13', '3.14']
        include:
          # Map OS to pixi platform
          - os: ubuntu-latest
            platform: linux-64
          - os: macos-13
            platform: osx-64
          - os: macos-latest
            platform: osx-arm64
          # Map Python version to pixi environment
          - python-version: '3.11'
            pixi-environment: py311
          - python-version: '3.12'
            pixi-environment: py312
          - python-version: '3.13'
            pixi-environment: default
          - python-version: '3.14'
            pixi-environment: py314

    runs-on: ${{ matrix.os }}

    name: ${{ matrix.platform }} / Python ${{ matrix.python-version }}

    steps:
      - name: Display run details
        run: |
          echo "============================================================="
          echo "Run #${GITHUB_RUN_NUMBER}"
          echo "Run ID: ${GITHUB_RUN_ID}"
          echo "Testing: ${GITHUB_REPOSITORY}"
          echo "Triggered by: ${GITHUB_EVENT_NAME}"
          echo "Initiated by: ${GITHUB_ACTOR}"
          echo "Platform: ${{ matrix.platform }}"
          echo "Python: ${{ matrix.python-version }}"
          echo "Pixi environment: ${{ matrix.pixi-environment }}"
          echo "============================================================="

      - name: Create SSH key for SNOPT
        if: secrets.SSH_PRIVATE_KEY && secrets.SNOPT_LOCATION_77
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          sudo chmod 600 ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.34.0
          cache: false
          environments: ${{ matrix.pixi-environment }}

      - name: Install build_pyoptsparse
        run: |
          echo "============================================================="
          echo "Install build_pyoptsparse in pixi environment"
          echo "============================================================="
          pixi run -e ${{ matrix.pixi-environment }} pip install -e .

      - name: Install pyoptsparse
        run: |
          echo "============================================================="
          echo "Install pyoptsparse from conda-forge"
          echo "============================================================="
          pixi add -e ${{ matrix.pixi-environment }} pyoptsparse

      - name: Display environment
        run: |
          echo "============================================================="
          echo "Pixi environment info"
          echo "============================================================="
          pixi info
          pixi list -e ${{ matrix.pixi-environment }}

          echo "============================================================="
          echo "Check Python, NumPy versions"
          echo "============================================================="
          pixi run -e ${{ matrix.pixi-environment }} python -c "import sys; print(f'Python: {sys.version}')"
          pixi run -e ${{ matrix.pixi-environment }} python -c "import numpy; print(f'NumPy: {numpy.__version__}')"
          pixi run -e ${{ matrix.pixi-environment }} python -c "import pyoptsparse; print(f'pyoptsparse: {pyoptsparse.__version__}')"

      - name: Copy SNOPT source files
        if: secrets.SSH_PRIVATE_KEY && secrets.SNOPT_LOCATION_77
        run: |
          echo "============================================================="
          echo "Copying SNOPT 7.7 source files via SSH"
          echo "============================================================="
          mkdir -p SNOPT
          scp -qr ${{ secrets.SNOPT_LOCATION_77 }} SNOPT
          ls -la SNOPT/src

      - name: Build SNOPT module
        if: secrets.SSH_PRIVATE_KEY && secrets.SNOPT_LOCATION_77
        run: |
          echo "============================================================="
          echo "Build SNOPT module with build_pyoptsparse"
          echo "============================================================="
          pixi run -e ${{ matrix.pixi-environment }} python -m build_pyoptsparse.build_snopt_module SNOPT/src

      - name: Test SNOPT module
        if: secrets.SSH_PRIVATE_KEY && secrets.SNOPT_LOCATION_77
        run: |
          echo "============================================================="
          echo "Test that SNOPT module can be imported"
          echo "============================================================="
          pixi run -e ${{ matrix.pixi-environment }} python -c "from pyoptsparse import SNOPT; print('SNOPT loaded successfully!')"

      # Enable tmate debugging of manually-triggered workflows if the input option was provided
      - name: Setup tmate session
        if: github.event_name == 'workflow_dispatch' && inputs.debug_enabled
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Setup tmate session after failure
        if: github.event_name == 'workflow_dispatch' && inputs.debug_enabled && failure()
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Notify slack on failure
        uses: act10ns/slack@v2.0.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: ${{ job.status }}
        if: failure()
